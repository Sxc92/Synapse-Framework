# ===========================================
# Synapse Security 模块完整配置示例
# ===========================================
# 使用自研的 TokenService 和 PermissionService
# 支持 UUID Token、数据权限、登录安全等功能

# ===========================================
# Synapse Security 核心配置
# ===========================================
synapse:
  security:
    # 是否启用安全模块
    enabled: true
    
    # 安全模式：STRICT(严格) | PERMISSIVE(宽松) | DISABLED(关闭)
    mode: STRICT
    
    # 是否启用安全日志
    security-logging: true
    
    # 安全日志级别
    security-log-level: INFO
    
    # ===========================================
    # 白名单路径配置
    # ===========================================
    white-list:
      # 是否启用白名单
      enabled: true
      
      # 白名单路径列表（支持 Ant 风格路径匹配）
      paths:
        - /api/auth/login
        - /api/auth/logout
        - /actuator/**
        - /swagger-ui/**
        - /v3/api-docs/**
        - /webjars/**
        - /favicon.ico
        - /error
    
    # ===========================================
    # Token 配置
    # ===========================================
    token:
      # Token 前缀（用于 Authorization 请求头）
      # 默认 "Bearer "，可根据需要修改（如 "Token "、"JWT " 等）
      prefix: "Bearer "
      
      # Token 查询参数名
      # 默认 "token"，可根据需要修改（如 "access_token"、"auth_token" 等）
      query-param: "token"
      
      # Authorization 请求头名称
      # 默认 "Authorization"，一般不需要修改
      header-name: "Authorization"
      
      # X-Auth-Token 请求头名称（备用 token 传递方式）
      # 默认 "X-Auth-Token"，可根据需要修改
      x-auth-token-header: "X-Auth-Token"
    
    # ===========================================
    # Gateway 签名配置
    # ===========================================
    gateway-signature:
      # 是否启用 Gateway 签名验证
      enabled: true
      
      # Gateway 签名密钥（生产环境必须修改为强密钥）
      secret: "synapse-gateway-secret-key-change-in-production"
      
      # 签名有效期窗口（毫秒），默认 5 分钟，防止重放攻击
      validity-window: 300000
      
      # 是否启用用户上下文传递
      # 启用后，Gateway 会将用户上下文编码到请求头，减少微服务的 Redis 查询
      enable-context-passing: true

# ===========================================
# Redis 配置（用于存储用户会话和Token）
# ===========================================
spring:
  redis:
    # Redis服务器地址
    host: localhost
    
    # Redis服务器端口
    port: 6379
    
    # Redis密码（如果有）
    password: 
    
    # Redis数据库索引
    database: 0
    
    # 连接超时时间
    timeout: 5000ms
    
    # 连接池配置
    lettuce:
      pool:
        # 连接池最大连接数
        max-active: 8
        
        # 连接池最大空闲连接数
        max-idle: 8
        
        # 连接池最小空闲连接数
        min-idle: 0
        
        # 连接池最大阻塞等待时间
        max-wait: -1ms

# ===========================================
# 日志配置
# ===========================================
logging:
  level:
    # Synapse Security 模块日志级别
    com.indigo.security: INFO
    
    # 根日志级别
    root: INFO
  
  # 日志格式配置
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# ===========================================
# Web 安全配置
# ===========================================
server:
  # 服务器端口
  port: 8080
  
  # 请求头大小限制
  max-http-header-size: 8KB
  
  # 请求体大小限制
  max-http-post-size: 2MB

# ===========================================
# 管理端点配置
# ===========================================
management:
  endpoints:
    web:
      exposure:
        # 暴露的管理端点
        include: health,info,metrics,prometheus
      
      # 管理端点基础路径
      base-path: /actuator
  
  # 健康检查配置
  health:
    # 显示详细信息
    show-details: when-authorized
    
    # 自定义健康检查
    defaults:
      enabled: true

# ===========================================
# 缓存配置
# ===========================================
spring:
  cache:
    type: redis
    
    # 缓存名称配置
    cache-names:
      - user-session
      - permission-cache
      - data-permission-rules
    
    # Redis缓存配置
    redis:
      # 缓存过期时间（毫秒）
      time-to-live: 3600000
      
      # 是否缓存空值
      cache-null-values: false
      
      # 键前缀
      key-prefix: "synapse:security:"
      
      # 是否使用键前缀
      use-key-prefix: true

# ===========================================
# 监控配置
# ===========================================
management:
  metrics:
    # 启用指标收集
    enabled: true
    
    # 指标导出配置
    export:
      prometheus:
        enabled: true
        
    # 自定义指标
    distribution:
      percentiles-histogram:
        http.server.requests: true
      
      percentiles:
        http.server.requests: 0.5, 0.95, 0.99

# ===========================================
# 环境特定配置示例
# ===========================================

---
# 开发环境配置
spring:
  config:
    activate:
      on-profile: dev

synapse:
  security:
    # 开发环境使用宽松模式
    mode: PERMISSIVE
    
    # 启用详细日志
    security-logging: true
    security-log-level: DEBUG

logging:
  level:
    com.indigo.security: DEBUG

---
# 测试环境配置
spring:
  config:
    activate:
      on-profile: test

synapse:
  security:
    # 测试环境使用严格模式
    mode: STRICT
    
    # 禁用安全日志
    security-logging: false

---
# 生产环境配置
spring:
  config:
    activate:
      on-profile: prod

synapse:
  security:
    # 生产环境使用严格模式
    mode: STRICT
    
    # 生产环境配置

logging:
  level:
    com.indigo.security: WARN
    root: WARN

# 生产环境Redis配置
spring:
  redis:
    host: redis-prod.example.com
    port: 6379
    password: ${REDIS_PASSWORD:}
    database: 0
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5
        max-wait: 3000ms
